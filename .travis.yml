dist: xenial
env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
services:
  - docker
addons:
  apt:
    packages:
      - docker-ce
      - expect-dev # for unbuffer: brings color back into travis logs

stages:
  - name: build / unit-testing
    if: tag IS blank
  - name: integration-testing
    if: tag IS blank
  - name: system-testing
    if: tag IS blank
  - deployment

jobs:
  include:
    # build images ----------------------------------------------------------------------
    - stage: build / unit-testing
      # in pull request we do not have credentials to push, so this is useless
      if: NOT type = pull_request
      name: build jupyter notebooks
      before_install:
        - sudo bash ops/travis/build/dy-jupyter before_install
      install:
        - unbuffer bash ops/travis/build/dy-jupyter install
      before_script:
        - unbuffer bash ops/travis/build/dy-jupyter before_script
      script:
        - unbuffer bash ops/travis/build/dy-jupyter script
      after_success:
        - unbuffer bash ops/travis/build/dy-jupyter after_success
      after_failure:
        - unbuffer bash ops/travis/build/dy-jupyter after_failure
      deploy:
        - provider: script
          skip_cleanup: true
          script: unbuffer bash ops/travis/build/dy-jupyter deploy
          on:
            all_branches: true

    # unit test 2D graphs ----------------------------------------------------------------------
    - stage: build / unit-testing
      name: 2D graphs
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - sudo bash ops/travis/unit-testing/webserver before_install
      install:
        - unbuffer bash ops/travis/unit-testing/webserver install
      before_script:
        - unbuffer bash ops/travis/unit-testing/webserver before_script
      script:
        - unbuffer bash ops/travis/unit-testing/webserver script
      after_success:
        - unbuffer bash ops/travis/unit-testing/webserver after_success
      after_failure:
        - unbuffer bash ops/travis/unit-testing/webserver after_failure

    # integration testing 2D graphs -------------------------------------------------------------
    - stage: integration-testing
      name: simcore-sdk in swarm
      language: python
      python:
        - "3.6"
      sudo: required
      cache: pip
      before_install:
        - sudo bash ops/travis/integration-testing/simcore-sdk before_install
      install:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk install
      before_script:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk before_script
      script:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk script
      after_success:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk after_success
      after_failure:
        - unbuffer bash ops/travis/integration-testing/simcore-sdk after_failure

    # deployment -------------------------------------------------------------------------------
    - stage: deployment
      name: master
      if: branch = master
      git:
        depth: false
      script: echo "Deploy master"
      deploy:
        - provider: script
          script: unbuffer bash ops/travis/deploy/master
          on:
            branch: master
    - stage: deployment
      name: staging
      if: branch = staging
      git:
        depth: false
      script: echo "Deploy staging"
      deploy:
        - provider: script
          script: unbuffer bash ops/travis/deploy/staging
          on:
            branch: staging

notifications:
  email:
    on_success: never
    on_failure: always
